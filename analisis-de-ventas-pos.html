<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Análisis de Productos Facturados</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Estilo general */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-user-drag: none;
      -moz-user-drag: none;
      user-drag: none;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: #ecf0f1;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #47627d;
      padding: 10px 20px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .header-icons {
      display: flex;
      gap: 15px;
    }

    .icon {
      color: #15a086;
      font-size: 1.8em;
      transition: transform 0.3s ease, color 0.3s ease;
      cursor: pointer;
    }

    .icon:hover {
      transform: scale(1.2);
      color: #16e086;
    }

    #invoiceUser {
      font-size: 1.2em;
      font-weight: bold;
    }

    /* Main Container */
    .main-container {
      margin-top: 60px;
      flex-grow: 1;
      min-height: calc(100vh - 120px);
      padding: 20px;
    }

    /* Sales Analysis Section */
    .sales-analysis-section {
      background: #34495e;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      width: 100%;
      height: calc(100vh - 180px);
      overflow-y: auto;
    }

    .sales-analysis-section h1 {
      font-size: 1.8em;
      margin-bottom: 20px;
      color: #16e086;
      text-align: center;
    }

    .date-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
      justify-content: center;
    }

    .date-filter input {
      padding: 8px;
      border-radius: 5px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #ecf0f1;
    }

    .date-filter button {
      padding: 8px 15px;
      background: #16e086;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .date-filter button:hover {
      background: #15a086;
    }

    .sales-categories {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .sales-category {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
      transition: all 0.3s;
    }

    .sales-category:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-5px);
    }

    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .category-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #16e086;
    }

    .category-total {
      font-weight: bold;
      background: rgba(22, 224, 134, 0.2);
      padding: 5px 10px;
      border-radius: 5px;
    }

    .top-product {
      margin-bottom: 15px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 5px;
    }

    .product-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .product-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.9em;
      color: #95a5a6;
    }

    .suggestion {
      margin-top: 15px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 5px;
      border-left: 3px solid #16e086;
    }

    .suggestion-title {
      font-weight: bold;
      margin-bottom: 5px;
      color: #16e086;
    }

    .suggestion-text {
      font-size: 0.9em;
    }

    .no-products {
      text-align: center;
      padding: 20px;
      color: #95a5a6;
      font-style: italic;
    }

    .analysis-charts {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }

    .chart-wrapper {
      flex: 1;
      min-width: 300px;
      max-width: 45%;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 15px;
    }

    .chart-title {
      text-align: center;
      margin-bottom: 15px;
      color: #16e086;
      font-weight: bold;
    }

    .print-btn {
      background: linear-gradient(135deg, #16e086, #15a086);
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s;
    }

    .print-btn:hover {
      background: linear-gradient(135deg, #15a086, #16e086);
      transform: translateY(-2px);
    }

    .print-btn i {
      font-size: 16px;
    }

    /* Footer */
    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #2c3e50;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .footer-buttons {
      display: flex;
      gap: 10px;
    }

    .button {
      padding: 12px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      font-size: 1em;
      color: #ecf0f1;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.3s, transform 0.3s;
      text-decoration: none;
    }

    .button:hover {
      transform: scale(1.05);
    }

    .button i {
      font-size: 1.2em;
    }

    .button-home {
      background-color: #8e44ad;
    }

    .button-home:hover {
      background-color: #9b59b6;
    }

    /* Estilos para navegadores Webkit (scrollbar) */
    ::-webkit-scrollbar-track {
      background-color: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background-color: transparent;
      border-radius: 10px;
      height: 10px;
      transition: background-color 0.3s ease;
    }

    ::-webkit-scrollbar {
      width: 12px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background-color: #15a086;
    }

    ::-webkit-scrollbar-thumb:active {
      background-color: #0d705c;
    }

    /* Responsividad */
    @media (max-width: 768px) {
      .sales-categories {
        grid-template-columns: 1fr;
      }
      
      .chart-wrapper {
        min-width: 100%;
        max-width: 100%;
      }
      
      .analysis-charts {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-icons"> 
      <a href="index.html" id="homeBtn" title="Inicio"><i class="fa-solid fa-house icon"></i></a>
      <a href="inventario.html" id="inventoryBtn" title="Inventario"><i class="fa-solid fa-box icon"></i></a>
      <a href="reportes.html" id="reportsBtn" title="Reportes"><i class="fa-solid fa-chart-line icon"></i></a>
      <a href="facturas.html" id="invoicesBtn" title="Facturas"><i class="fa-solid fa-receipt icon"></i></a>
      <a href="#" id="salesAnalysisBtn" title="Análisis de Ventas" style="color: #16e086;"><i class="fa-solid fa-chart-pie icon"></i></a>
      <a href="usuario.html" id="userBtn" title="Usuario"><i class="fa-solid fa-user icon"></i></a>
    </div>
    <span id="invoiceUser">Usuario</span>
  </header>

  <div class="main-container">
    <div class="sales-analysis-section">
      <h1>Análisis de Productos Facturados</h1>
      <div class="date-filter">
        <input type="date" id="analysisDateFilter">
        <button id="applyAnalysisFilter">Filtrar</button>
        <button id="printAnalysisReport" class="print-btn"><i class="fas fa-print"></i> Imprimir Análisis</button>
      </div>
      
      <div id="salesAnalysisContent">
        <div class="sales-categories">
          <div class="sales-category">
            <div class="category-header">
              <span class="category-title">Más Vendidos</span>
              <span class="category-total">Top 3</span>
            </div>
            <div id="topProducts">
              <!-- Se llenará dinámicamente -->
            </div>
            <div class="suggestion">
              <div class="suggestion-title">Sugerencia</div>
              <div class="suggestion-text">Promocione estos productos como "Los más populares" para aumentar aún más sus ventas.</div>
            </div>
          </div>
          
          <div class="sales-category">
            <div class="category-header">
              <span class="category-title">Menos Vendidos</span>
              <span class="category-total">Por mejorar</span>
            </div>
            <div id="bottomProducts">
              <!-- Se llenará dinámicamente -->
            </div>
            <div class="suggestion">
              <div class="suggestion-title">Sugerencia</div>
              <div class="suggestion-text">Considere promociones especiales o paquetes para estos productos.</div>
            </div>
          </div>
          
          <div class="sales-category">
            <div class="category-header">
              <span class="category-title">Sin Ventas</span>
              <span class="category-total">Oportunidad</span>
            </div>
            <div id="noSalesProducts">
              <!-- Se llenará dinámicamente -->
            </div>
            <div class="suggestion">
              <div class="suggestion-title">Sugerencia</div>
              <div class="suggestion-text">Revise el precio, ubicación o considere eliminarlos si no generan interés.</div>
            </div>
          </div>
        </div>
        
        <div class="analysis-charts">
          <div class="chart-wrapper">
            <div class="chart-title">Productos Más Vendidos</div>
            <canvas id="topProductsChart"></canvas>
          </div>
          
          <div class="chart-wrapper">
            <div class="chart-title">Distribución de Ventas</div>
            <canvas id="bottomProductsChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="footer-buttons">
      <a href="index.html" class="button button-home"><i class="fa-solid fa-house"></i> Volver al Inicio</a>
    </div>
    <div id="currentDate" style="color: #ecf0f1;"></div>
  </div>

  <script type="module">
    // Importaciones de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs,
      Timestamp,
      orderBy,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { 
      getAuth, 
      onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

    // Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Elementos del DOM
    const invoiceUser = document.getElementById("invoiceUser");
    const analysisDateFilter = document.getElementById("analysisDateFilter");
    const applyAnalysisFilter = document.getElementById("applyAnalysisFilter");
    const printAnalysisReport = document.getElementById("printAnalysisReport");
    const topProducts = document.getElementById("topProducts");
    const bottomProducts = document.getElementById("bottomProducts");
    const noSalesProducts = document.getElementById("noSalesProducts");
    const topProductsChart = document.getElementById("topProductsChart");
    const bottomProductsChart = document.getElementById("bottomProductsChart");
    const currentDate = document.getElementById("currentDate");

    // Variables globales
    let currentUser = null;
    let topProductsChartInstance = null;
    let bottomProductsChartInstance = null;

    // Función para obtener sugerencias aleatorias de productos
    const getRandomSuggestions = (products, count) => {
      const shuffled = [...products].sort(() => 0.5 - Math.random());
      return shuffled.slice(0, count);
    };

    // Función para cargar el análisis de ventas
    const loadSalesAnalysis = async (date = null) => {
      if (!currentUser) return;

      try {
        let startDate = new Date();
        startDate.setHours(0, 0, 0, 0);
        
        if (date) {
          startDate = new Date(date);
          startDate.setHours(0, 0, 0, 0);
        }
        
        const endDate = new Date(startDate);
        endDate.setHours(23, 59, 59, 999);
        
        // Obtener todas las facturas del día
        const salesRef = collection(db, "users", currentUser.uid, "invoiceHistory");
        const q = query(salesRef, 
          where("date", ">=", Timestamp.fromDate(startDate)),
          where("date", "<=", Timestamp.fromDate(endDate))
        );
        
        const querySnapshot = await getDocs(q);
        
        if (querySnapshot.empty) {
          topProducts.innerHTML = '<div class="no-products">No hay ventas para analizar</div>';
          bottomProducts.innerHTML = '<div class="no-products">No hay ventas para analizar</div>';
          noSalesProducts.innerHTML = '<div class="no-products">No hay productos sin ventas</div>';
          return;
        }
        
        // Obtener todos los productos disponibles
        const businessesRef = collection(db, "businesses");
        const businessesSnapshot = await getDocs(businessesRef);
        
        const allProducts = [];
        const businessPromises = [];
        
        businessesSnapshot.forEach(businessDoc => {
          const productsRef = collection(db, "businesses", businessDoc.id, "products");
          const promise = getDocs(productsRef).then(productsSnapshot => {
            productsSnapshot.forEach(productDoc => {
              allProducts.push({
                id: productDoc.id,
                name: productDoc.data().name,
                businessName: businessDoc.id,
                sold: 0,
                total: 0
              });
            });
          });
          businessPromises.push(promise);
        });
        
        await Promise.all(businessPromises);
        
        // Procesar ventas
        const salesByProduct = {};
        let totalSales = 0;
        
        querySnapshot.forEach(doc => {
          const invoiceData = doc.data();
          invoiceData.items.forEach(item => {
            if (!salesByProduct[item.name]) {
              salesByProduct[item.name] = {
                quantity: 0,
                total: 0
              };
            }
            salesByProduct[item.name].quantity += item.quantity;
            salesByProduct[item.name].total += item.total;
            totalSales += item.total;
          });
        });
        
        // Actualizar productos vendidos
        allProducts.forEach(product => {
          if (salesByProduct[product.name]) {
            product.sold = salesByProduct[product.name].quantity;
            product.total = salesByProduct[product.name].total;
          }
        });
        
        // Separar productos en categorías
        const soldProducts = allProducts.filter(p => p.sold > 0);
        const notSoldProducts = allProducts.filter(p => p.sold === 0);
        
        // Ordenar productos vendidos por cantidad
        soldProducts.sort((a, b) => b.total - a.total);
        
        // Obtener sugerencias aleatorias
        const randomTopSelling = getRandomSuggestions(soldProducts.slice(0, 10), 3);
        const randomLowSelling = getRandomSuggestions(soldProducts.slice(-10), 3);
        const randomNoSales = getRandomSuggestions(notSoldProducts.slice(0, 10), 3);
        
        // Mostrar top 3 productos más vendidos (aleatorios)
        topProducts.innerHTML = '';
        if (randomTopSelling.length > 0) {
          randomTopSelling.forEach((product, index) => {
            const productDiv = document.createElement("div");
            productDiv.classList.add("top-product");
            productDiv.innerHTML = `
              <div class="product-name">${index + 1}. ${product.name}</div>
              <div class="product-stats">
                <span>Vendidos: ${product.sold}</span>
                <span>Total: $${product.total.toFixed(2)}</span>
              </div>
            `;
            topProducts.appendChild(productDiv);
          });
        } else {
          topProducts.innerHTML = '<div class="no-products">No hay productos vendidos</div>';
        }
        
        // Mostrar 3 productos menos vendidos (aleatorios)
        bottomProducts.innerHTML = '';
        if (randomLowSelling.length > 0) {
          randomLowSelling.forEach((product, index) => {
            const productDiv = document.createElement("div");
            productDiv.classList.add("top-product");
            productDiv.innerHTML = `
              <div class="product-name">${product.name}</div>
              <div class="product-stats">
                <span>Vendidos: ${product.sold}</span>
                <span>Total: $${product.total.toFixed(2)}</span>
              </div>
            `;
            bottomProducts.appendChild(productDiv);
          });
        } else {
          bottomProducts.innerHTML = '<div class="no-products">No hay suficientes productos vendidos</div>';
        }
        
        // Mostrar algunos productos no vendidos (aleatorios)
        noSalesProducts.innerHTML = '';
        if (randomNoSales.length > 0) {
          randomNoSales.forEach(product => {
            const productDiv = document.createElement("div");
            productDiv.classList.add("top-product");
            productDiv.innerHTML = `
              <div class="product-name">${product.name}</div>
              <div class="product-stats">
                <span>Vendidos: 0</span>
              </div>
            `;
            noSalesProducts.appendChild(productDiv);
          });
          
          if (notSoldProducts.length > 3) {
            noSalesProducts.innerHTML += `<div style="text-align: center; margin-top: 10px; color: #95a5a6; font-size: 0.9em;">+ ${notSoldProducts.length - 3} más sin ventas</div>`;
          }
        } else {
          noSalesProducts.innerHTML = '<div class="no-products">¡Todos los productos tuvieron ventas!</div>';
        }
        
        // Actualizar gráficos de análisis
        updateTopProductsChart(randomTopSelling);
        updateBottomProductsChart(randomLowSelling);
        
      } catch (error) {
        console.error("Error al analizar ventas:", error);
        alert('Error al analizar ventas');
      }
    };

    // Función para actualizar el gráfico de productos más vendidos
    const updateTopProductsChart = (topProducts) => {
      if (topProductsChartInstance) {
        topProductsChartInstance.destroy();
      }
      
      const ctx = topProductsChart.getContext('2d');
      
      const labels = topProducts.map(p => p.name);
      const data = topProducts.map(p => p.total);
      const backgroundColors = [
        'rgba(22, 224, 134, 0.7)',
        'rgba(54, 162, 235, 0.7)',
        'rgba(255, 206, 86, 0.7)'
      ];
      
      topProductsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'Productos Más Vendidos',
            data: data,
            backgroundColor: backgroundColors,
            borderColor: backgroundColors.map(c => c.replace('0.7', '1')),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          indexAxis: 'y',
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return '$' + value.toFixed(2);
                }
              }
            }
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: $${context.raw.toFixed(2)}`;
                }
              }
            }
          }
        }
      });
    };

    // Función para actualizar el gráfico de productos menos vendidos
    const updateBottomProductsChart = (bottomProducts) => {
      if (bottomProductsChartInstance) {
        bottomProductsChartInstance.destroy();
      }
      
      const ctx = bottomProductsChart.getContext('2d');
      
      const labels = bottomProducts.map(p => p.name);
      const data = bottomProducts.map(p => p.total);
      
      bottomProductsChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            label: 'Productos Menos Vendidos',
            data: data,
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(255, 159, 64, 0.7)',
              'rgba(255, 206, 86, 0.7)'
            ],
            borderColor: [
              'rgba(255, 99, 132, 1)',
              'rgba(255, 159, 64, 1)',
              'rgba(255, 206, 86, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: '#333',
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.label}: $${context.raw.toFixed(2)}`;
                }
              }
            },
            title: {
              display: false
            }
          }
        }
      });
    };

    // Función para imprimir el reporte de análisis
    const printAnalysisReportContent = () => {
      const today = new Date(analysisDateFilter.value).toLocaleDateString();
      
      // Obtener datos de los productos más vendidos
      const topProductsHTML = Array.from(document.querySelectorAll('#topProducts .top-product')).map(product => {
        return `
          <div style="margin-bottom: 10px; padding: 10px; border-bottom: 1px solid #eee;">
            <p><strong>${product.querySelector('.product-name').textContent}</strong></p>
            <p>${product.querySelector('.product-stats').textContent}</p>
          </div>
        `;
      }).join('');
      
      // Obtener datos de los productos menos vendidos
      const bottomProductsHTML = Array.from(document.querySelectorAll('#bottomProducts .top-product')).map(product => {
        return `
          <div style="margin-bottom: 10px; padding: 10px; border-bottom: 1px dashed #000; padding-bottom: 10px;">
            <p><strong>${product.querySelector('.product-name').textContent}</strong></p>
            <p>${product.querySelector('.product-stats').textContent}</p>
          </div>
        `;
      }).join('');
      
      // Obtener datos de los productos no vendidos
      const noSalesProductsHTML = Array.from(document.querySelectorAll('#noSalesProducts .top-product')).map(product => {
        return `
          <div style="margin-bottom: 10px; padding: 10px; border-bottom: 1px dashed #000; padding-bottom: 10px;">
            <p><strong>${product.querySelector('.product-name').textContent}</strong></p>
            <p>${product.querySelector('.product-stats').textContent}</p>
          </div>
        `;
      }).join('');
      
      const reportHTML = `
        <div style="width: 100%; max-width: 210mm; margin: 0 auto; padding: 20px; font-family: Arial, sans-serif;">
          <h1 style="text-align: center; margin-bottom: 20px;">Análisis de Ventas</h1>
          <p style="text-align: center; margin-bottom: 20px;"><strong>Fecha:</strong> ${today}</p>
          
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
              <h3 style="text-align: center; margin-bottom: 15px;">Productos Más Vendidos</h3>
              ${topProductsHTML || '<p style="text-align: center;">No hay datos</p>'}
            </div>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
              <h3 style="text-align: center; margin-bottom: 15px;">Productos Menos Vendidos</h3>
              ${bottomProductsHTML || '<p style="text-align: center;">No hay datos</p>'}
            </div>
            
            <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
              <h3 style="text-align: center; margin-bottom: 15px;">Productos Sin Ventas</h3>
              ${noSalesProductsHTML || '<p style="text-align: center;">No hay datos</p>'}
            </div>
          </div>
          
          <div style="margin-top: 30px; text-align: center;">
            <p>Reporte generado por: ${currentUser.displayName || currentUser.email.split('@')[0]}</p>
            <p>${new Date().toLocaleString()}</p>
          </div>
        </div>
      `;
      
      const printWindow = window.open('', '', 'width=800,height=600');
      printWindow.document.write('<html><head><title>Análisis de Ventas</title>');
      printWindow.document.write('<style>body { font-family: Arial; margin: 0; padding: 20px; }</style>');
      printWindow.document.write('</head><body>');
      printWindow.document.write(reportHTML);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.print();
    };

    // Event Listeners
    applyAnalysisFilter.addEventListener('click', () => {
      loadSalesAnalysis(analysisDateFilter.value);
    });

    printAnalysisReport.addEventListener('click', printAnalysisReportContent);

    // Observador de autenticación
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        
        if (user.displayName) {
          invoiceUser.textContent = user.displayName;
        } else {
          const nameFromEmail = user.email.split('@')[0];
          invoiceUser.textContent = nameFromEmail;
        }
        
        // Establecer fecha actual
        const today = new Date().toISOString().split('T')[0];
        analysisDateFilter.value = today;
        currentDate.textContent = new Date().toLocaleDateString('es-ES', { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        });
        
        // Cargar análisis inicial
        loadSalesAnalysis();
      } else {
        // Redirigir al login si no hay usuario autenticado
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>
