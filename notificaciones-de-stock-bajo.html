<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notificaciones de Stock Bajo</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Estilos generales heredados del sistema principal */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-user-drag: none;
      -moz-user-drag: none;
      user-drag: none;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: #ecf0f1;
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #47627d;
      padding: 10px 20px;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .header-icons {
      display: flex;
      gap: 15px;
    }

    .icon {
      color: #15a086;
      font-size: 1.8em;
      transition: transform 0.3s ease, color 0.3s ease;
      cursor: pointer;
    }

    .icon:hover {
      transform: scale(1.2);
      color: #16e086;
    }

    /* Main Container */
    .main-container {
      display: flex;
      margin-top: 60px;
      flex-grow: 1;
      min-height: calc(100vh - 120px);
    }

    /* Low Stock Section */
    .low-stock-container {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #34495e;
      border-radius: 10px;
      margin: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      height: calc(100vh - 180px);
    }

    .low-stock-container h1 {
      font-size: 1.8em;
      margin-bottom: 20px;
      color: #16e086;
      text-align: center;
    }

    /* Threshold Control */
    .threshold-control {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 8px;
    }

    .threshold-control label {
      font-weight: bold;
      color: #95a5a6;
    }

    .threshold-control input {
      padding: 8px;
      border-radius: 5px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #ecf0f1;
      width: 60px;
      text-align: center;
    }

    .update-threshold-btn {
      padding: 8px 15px;
      background: #16e086;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .update-threshold-btn:hover {
      background: #15a086;
    }

    /* Low Stock List */
    .low-stock-list {
      margin-top: 20px;
    }

    .low-stock-item {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .low-stock-item.critical {
      background: rgba(255, 99, 71, 0.2);
      border-left: 5px solid #ff6347;
    }

    .low-stock-item.warning {
      background: rgba(255, 165, 0, 0.2);
      border-left: 5px solid #ffa500;
    }

    .low-stock-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .product-image {
      width: 60px;
      height: 60px;
      object-fit: contain;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
    }

    .product-info {
      flex: 1;
    }

    .product-name {
      font-weight: bold;
      margin-bottom: 5px;
      color: #16e086;
    }

    .product-details {
      display: flex;
      gap: 15px;
      font-size: 0.9em;
    }

    .product-detail {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .stock-indicator {
      width: 100px;
      height: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      overflow: hidden;
      margin-top: 5px;
    }

    .stock-level {
      height: 100%;
      background: #16e086;
    }

    .reorder-btn {
      padding: 8px 15px;
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .reorder-btn:hover {
      background: #3498db;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #95a5a6;
    }

    .empty-state i {
      font-size: 3em;
      margin-bottom: 15px;
      color: #16e086;
    }

    /* Totals Bar */
    .totals-bar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #2c3e50;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .button {
      padding: 12px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
      font-size: 1em;
      color: #ecf0f1;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.3s, transform 0.3s;
      text-decoration: none;
    }

    .button:hover {
      transform: scale(1.05);
    }

    .button i {
      font-size: 1.2em;
    }

    .button-home {
      background-color: #8e44ad;
    }

    .button-home:hover {
      background-color: #9b59b6;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .low-stock-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .product-details {
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-icons">
      <a href="#" id="homeBtn" title="Inicio"><i class="fa-solid fa-house icon"></i></a>
      <a href="#" id="refreshBtn" title="Actualizar"><i class="fa-solid fa-rotate icon"></i></a>
    </div>
    <span id="invoiceUser">Notificaciones de Stock Bajo</span>
  </header>

  <!-- Main Container -->
  <div class="main-container">
    <!-- Low Stock Section -->
    <div class="low-stock-container">
      <h1>Productos con Stock Bajo</h1>
      
      <!-- Threshold Control -->
      <div class="threshold-control">
        <label>Umbral de notificación:</label>
        <input type="number" id="thresholdInput" min="1" value="5">
        <button class="update-threshold-btn" id="updateThresholdBtn">
          <i class="fa-solid fa-save"></i> Actualizar
        </button>
        <span style="margin-left: auto; font-size: 0.9em; color: #95a5a6;">
          <i class="fa-solid fa-circle" style="color: #ff6347;"></i> Crítico 
          <i class="fa-solid fa-circle" style="color: #ffa500; margin-left: 10px;"></i> Advertencia
        </span>
      </div>
      
      <!-- Low Stock List -->
      <div class="low-stock-list" id="lowStockList">
        <div class="empty-state">
          <i class="fa-solid fa-check-circle"></i>
          <h3>Todo en orden</h3>
          <p>No hay productos con stock bajo según el umbral actual</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Totals Bar -->
  <div class="totals-bar">
    <div class="total-container" id="lowStockSummary">
      <i class="fa-solid fa-boxes-stacked"></i> Resumen: 0 productos con stock bajo
    </div>
    <div class="action-buttons">
      <button class="button button-home" id="backToPosBtn"><i class="fa-solid fa-cash-register"></i> Volver al POS</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      query, 
      where, 
      getDocs,
      doc,
      getDoc,
      updateDoc,
      setDoc
    } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

    // Configuración de Firebase (debe coincidir con tu configuración principal)
    const firebaseConfig = {
      apiKey: "AIzaSyDLi-egzQlgbKW8XV_qIhU6313Gd8gocCg",
      authDomain: "inventario-35d6b.firebaseapp.com",
      projectId: "inventario-35d6b",
      storageBucket: "inventario-35d6b.appspot.com",
      messagingSenderId: "266100399659",
      appId: "1:266100399659:web:92358d28cbd803c8a7d46e",
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Elementos del DOM
    const homeBtn = document.getElementById('homeBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const backToPosBtn = document.getElementById('backToPosBtn');
    const thresholdInput = document.getElementById('thresholdInput');
    const updateThresholdBtn = document.getElementById('updateThresholdBtn');
    const lowStockList = document.getElementById('lowStockList');
    const lowStockSummary = document.getElementById('lowStockSummary');

    // Variables globales
    let currentUser = null;
    let currentThreshold = 5;
    let lowStockProducts = [];

    // Observador de autenticación
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loadThreshold();
        loadLowStockProducts();
      } else {
        // Redirigir al login si no está autenticado
        window.location.href = 'index.html';
      }
    });

    // Cargar umbral de notificación
    async function loadThreshold() {
      try {
        const thresholdRef = doc(db, "users", currentUser.uid, "settings", "stockThreshold");
        const thresholdDoc = await getDoc(thresholdRef);
        
        if (thresholdDoc.exists()) {
          currentThreshold = thresholdDoc.data().value || 5;
          thresholdInput.value = currentThreshold;
        } else {
          // Crear umbral por defecto si no existe
          await setDoc(thresholdRef, { value: 5 });
          thresholdInput.value = 5;
        }
      } catch (error) {
        console.error("Error al cargar umbral:", error);
        showAlert('error', 'Error al cargar configuración de umbral');
      }
    }

    // Cargar productos con stock bajo
    async function loadLowStockProducts() {
      try {
        const businessesRef = collection(db, "businesses");
        const businessesSnapshot = await getDocs(businessesRef);
        
        lowStockProducts = [];
        let criticalCount = 0;
        let warningCount = 0;
        
        lowStockList.innerHTML = '';
        
        for (const businessDoc of businessesSnapshot.docs) {
          const productsRef = collection(db, "businesses", businessDoc.id, "products");
          const productsQuery = query(productsRef, where("quantity", "<=", currentThreshold * 2));
          const productsSnapshot = await getDocs(productsQuery);
          
          for (const productDoc of productsSnapshot.docs) {
            const productData = productDoc.data();
            
            if (productData.quantity <= currentThreshold) {
              lowStockProducts.push({
                id: productDoc.id,
                businessId: businessDoc.id,
                ...productData,
                status: 'critical'
              });
              criticalCount++;
            } else if (productData.quantity <= currentThreshold * 2) {
              lowStockProducts.push({
                id: productDoc.id,
                businessId: businessDoc.id,
                ...productData,
                status: 'warning'
              });
              warningCount++;
            }
          }
        }
        
        // Mostrar resumen
        const totalLowStock = criticalCount + warningCount;
        lowStockSummary.innerHTML = `
          <i class="fa-solid fa-boxes-stacked"></i> 
          Resumen: ${totalLowStock} productos con stock bajo 
          (${criticalCount} críticos, ${warningCount} advertencias)
        `;
        
        // Mostrar productos
        if (lowStockProducts.length === 0) {
          lowStockList.innerHTML = `
            <div class="empty-state">
              <i class="fa-solid fa-check-circle"></i>
              <h3>Todo en orden</h3>
              <p>No hay productos con stock bajo según el umbral actual</p>
            </div>
          `;
          return;
        }
        
        // Ordenar productos: críticos primero, luego por cantidad ascendente
        lowStockProducts.sort((a, b) => {
          if (a.status === 'critical' && b.status !== 'critical') return -1;
          if (a.status !== 'critical' && b.status === 'critical') return 1;
          return a.quantity - b.quantity;
        });
        
        // Mostrar cada producto
        for (const product of lowStockProducts) {
          const productItem = document.createElement('div');
          productItem.className = `low-stock-item ${product.status}`;
          
          // Obtener URL de la imagen (si existe)
          let imageUrl = 'https://via.placeholder.com/60x60?text=No+Image';
          if (product.imageUrl) {
            try {
              const imageRef = ref(storage, product.imageUrl);
              imageUrl = await getDownloadURL(imageRef);
            } catch (error) {
              console.error("Error al cargar imagen:", error);
            }
          }
          
          // Calcular porcentaje de stock (para la barra de progreso)
          const stockPercentage = (product.quantity / (currentThreshold * 2)) * 100;
          
          productItem.innerHTML = `
            <img src="${imageUrl}" alt="${product.name}" class="product-image">
            <div class="product-info">
              <div class="product-name">${product.name}</div>
              <div class="product-details">
                <div class="product-detail">
                  <i class="fa-solid fa-box"></i> Stock: ${product.quantity}
                </div>
                <div class="product-detail">
                  <i class="fa-solid fa-barcode"></i> ${product.eanUpcCode || 'N/A'}
                </div>
                <div class="product-detail">
                  <i class="fa-solid fa-tag"></i> $${product.pricePerUnit.toFixed(2)}
                </div>
              </div>
              <div class="stock-indicator">
                <div class="stock-level" style="width: ${stockPercentage}%"></div>
              </div>
            </div>
            <button class="reorder-btn" data-id="${product.id}" data-business="${product.businessId}">
              <i class="fa-solid fa-truck-arrow-right"></i> Reabastecer
            </button>
          `;
          
          lowStockList.appendChild(productItem);
        }
        
        // Agregar eventos a los botones de reabastecer
        document.querySelectorAll('.reorder-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const productId = e.currentTarget.getAttribute('data-id');
            const businessId = e.currentTarget.getAttribute('data-business');
            reorderProduct(businessId, productId);
          });
        });
      } catch (error) {
        console.error("Error al cargar productos con stock bajo:", error);
        showAlert('error', 'Error al cargar productos con stock bajo');
      }
    }

    // Actualizar umbral de notificación
    async function updateThreshold() {
      const newThreshold = parseInt(thresholdInput.value);
      
      if (isNaN(newThreshold) || newThreshold < 1) {
        showAlert('warning', 'Ingrese un valor válido (mayor o igual a 1)');
        return;
      }
      
      try {
        const thresholdRef = doc(db, "users", currentUser.uid, "settings", "stockThreshold");
        await setDoc(thresholdRef, { value: newThreshold });
        
        currentThreshold = newThreshold;
        loadLowStockProducts();
        showAlert('success', 'Umbral actualizado correctamente');
      } catch (error) {
        console.error("Error al actualizar umbral:", error);
        showAlert('error', 'Error al actualizar umbral');
      }
    }

    // Marcar producto para reabastecimiento
    async function reorderProduct(businessId, productId) {
      try {
        const productRef = doc(db, "businesses", businessId, "products", productId);
        await updateDoc(productRef, {
          needsReorder: true,
          reorderDate: new Date()
        });
        
        showAlert('success', 'Producto marcado para reabastecimiento');
        loadLowStockProducts();
      } catch (error) {
        console.error("Error al marcar producto:", error);
        showAlert('error', 'Error al marcar producto para reabastecimiento');
      }
    }

    // Función para mostrar alertas
    function showAlert(type, message) {
      const alertDiv = document.createElement('div');
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.left = '50%';
      alertDiv.style.transform = 'translateX(-50%)';
      alertDiv.style.padding = '15px 20px';
      alertDiv.style.borderRadius = '5px';
      alertDiv.style.zIndex = '1000';
      alertDiv.style.display = 'flex';
      alertDiv.style.alignItems = 'center';
      alertDiv.style.gap = '10px';
      
      const icon = document.createElement('i');
      icon.className = 'fa-solid ';
      
      if (type === 'success') {
        alertDiv.style.backgroundColor = 'rgba(22, 224, 134, 0.9)';
        icon.className += 'fa-circle-check';
      } else if (type === 'error') {
        alertDiv.style.backgroundColor = 'rgba(255, 99, 71, 0.9)';
        icon.className += 'fa-circle-xmark';
      } else if (type === 'warning') {
        alertDiv.style.backgroundColor = 'rgba(253, 203, 110, 0.9)';
        icon.className += 'fa-triangle-exclamation';
      }
      
      const text = document.createElement('span');
      text.textContent = message;
      
      alertDiv.appendChild(icon);
      alertDiv.appendChild(text);
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.style.opacity = '0';
        alertDiv.style.transition = 'opacity 0.5s';
        setTimeout(() => {
          document.body.removeChild(alertDiv);
        }, 500);
      }, 3000);
    }

    // Event Listeners
    homeBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    refreshBtn.addEventListener('click', () => {
      loadLowStockProducts();
    });

    backToPosBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    updateThresholdBtn.addEventListener('click', updateThreshold);

    thresholdInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        updateThreshold();
      }
    });

    // Cargar datos al iniciar
    window.onload = function() {
      if (currentUser) {
        loadLowStockProducts();
      }
    };
  </script>
</body>
</html>
